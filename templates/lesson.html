{% extends "base.html" %}
{% block content %}

<div class="rounded-3xl border border-slate-200 bg-white p-6 dark:border-slate-800 dark:bg-slate-900/60">
  <div class="flex items-center justify-between gap-3">
    <div>
      <div class="text-xs tracking-wide text-slate-500 dark:text-slate-400">LESSON</div>
      <div class="text-2xl font-extrabold">{{ lesson.title }}</div>
      {% if lesson.section %}
        <div class="text-xs text-slate-500 dark:text-slate-400">Section: {{ lesson.section }}</div>
      {% endif %}
    </div>
    <a class="px-4 py-2 rounded-xl border border-slate-200 hover:border-slate-400 dark:border-slate-800 dark:hover:border-slate-600"
       href="{% if lesson.section %}/section/{{ lesson.section }}{% else %}/{% endif %}">‚Üê Back</a>
  </div>

  <div class="mt-6 prose max-w-none dark:prose-invert">
    {{ body_html | safe }}
  </div>

  {% if exercises and exercises|length > 0 %}
    <hr class="my-8 border-slate-200 dark:border-slate-800">
    <div class="text-xl font-extrabold">Practice</div>

    <div class="mt-4 space-y-4">
      {% for ex in exercises %}
        <div class="rounded-2xl border border-slate-200 p-4 dark:border-slate-800">
          <div class="font-bold">{{ loop.index }}. {{ ex.question }}</div>

          <form class="mt-3 space-y-2" onsubmit="return checkEx(event, {{ ex.id }});">
            <input type="hidden" name="ex_id" value="{{ ex.id }}">

            <div class="space-y-2">
              {% set choices = ex.choices_json %}
              <textarea name="choices_json" hidden>{{ choices }}</textarea>

              <div id="choices-{{ ex.id }}"></div>

              <input name="answer" class="w-full rounded-xl border border-slate-200 px-3 py-2 bg-slate-50 dark:border-slate-800 dark:bg-slate-950/40"
                     placeholder="Type your answer or pick a choice..." />
            </div>

            <button class="px-4 py-2 rounded-xl bg-slate-900 text-white font-bold hover:bg-slate-800">
              Check
            </button>

            <div id="result-{{ ex.id }}" class="mt-3 text-sm"></div>
          </form>
        </div>
      {% endfor %}
    </div>
  {% endif %}
</div>

<script>
  // render choices
  (function(){
    const forms = document.querySelectorAll("form");
    forms.forEach(f => {
      const exId = f.querySelector("input[name='ex_id']")?.value;
      const holder = document.getElementById("choices-" + exId);
      const raw = f.querySelector("textarea[name='choices_json']")?.value || "[]";
      let arr = [];
      try { arr = JSON.parse(raw); } catch(e){ arr = []; }

      if (Array.isArray(arr) && arr.length) {
        holder.innerHTML = arr.map((c, i) => `
          <label class="flex items-center gap-2">
            <input type="radio" name="pick_${exId}" value="${String(c).replace(/"/g,'&quot;')}"
                   onchange="this.closest('form').querySelector('input[name=answer]').value=this.value;">
            <span>${c}</span>
          </label>
        `).join("");
      }
    });
  })();

  async function checkEx(ev, exId){
    ev.preventDefault();
    const form = ev.target;
    const ans = form.querySelector("input[name=answer]").value || "";
    const resBox = document.getElementById("result-" + exId);

    const fd = new FormData();
    fd.append("answer", ans);

    const r = await fetch(`/exercise/${exId}/check`, { method: "POST", body: fd });
    const data = await r.json();

    if (data.ok) {
      resBox.innerHTML = `<div class="font-bold text-emerald-600">Correct</div>` + (data.explanation_html || "");
    } else {
      resBox.innerHTML = `<div class="font-bold text-rose-500">Wrong</div>
                          <div class="text-slate-500">Correct answer: <b>${data.correct}</b></div>` +
                          (data.explanation_html || "");
    }
    return false;
  }
</script>

{% endblock %}
